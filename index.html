<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Data Extractor Pro v4.17 (Smart Defaults)</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF & OCR Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Export Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; height: 100vh; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Highlight & Editable */
        .highlight { background-color: #fef08a; color: #854d0e; font-weight: bold; border-radius: 2px; padding: 0 2px; }
        .target-line { background-color: #eff6ff; display: block; padding: 2px 4px; border-left: 3px solid #3b82f6; font-weight: 500; color: #1e293b; }
        .context-line { display: block; padding: 0 4px; color: #64748b; }
        
        .editable-cell:hover { background-color: #fff; box-shadow: inset 0 0 0 1px #3b82f6; cursor: text; }
        .editing textarea { width: 100%; height: 100%; min-height: 60px; outline: none; border: 2px solid #3b82f6; border-radius: 4px; padding: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; resize: vertical; }

        /* Animations */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .cursor-wait { cursor: wait; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);

        const removeVietnameseTones = (str) => {
            if (!str) return "";
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"); 
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"); 
            str = str.replace(/ì|í|ị|ỉ|ĩ/g,"i"); 
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"); 
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"); 
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"); 
            str = str.replace(/đ/g,"d");
            str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
            str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
            str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
            str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
            str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
            str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
            str = str.replace(/Đ/g, "D");
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
        }

        const applyTextTransform = (text, mode) => {
            if (!text) return "";
            switch (mode) {
                case 'uppercase': return text.toUpperCase();
                case 'lowercase': return text.toLowerCase();
                case 'sentence_case': 
                    const lower = text.toLowerCase();
                    return lower.replace(/(^\s*\w)/, c => c.toUpperCase());
                case 'no_accent_upper':
                    return removeVietnameseTones(text).toUpperCase();
                case 'no_accent_upper_alpha':
                    return removeVietnameseTones(text).toUpperCase().replace(/[^A-Z0-9\s]/g, '');
                default: return text;
            }
        }

        const transformHtmlContent = (htmlContent, mode) => {
            if (!htmlContent) return "";
            if (mode === 'none') return htmlContent;
            // Split by tags to only transform text content
            const parts = htmlContent.split(/(<[^>]+>)/g);
            return parts.map(part => {
                if (part.trim().startsWith('<')) {
                    return part;
                } else {
                    return applyTextTransform(part, mode);
                }
            }).join('');
        };

        const parsePageRange = (rangeStr) => {
            if (!rangeStr || typeof rangeStr !== 'string' || rangeStr.trim() === '') return null;
            const pages = new Set();
            const parts = rangeStr.split(',');
            parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.includes('-')) {
                    const [start, end] = trimmed.split('-').map(Number);
                    if (!isNaN(start) && !isNaN(end) && start <= end) {
                        for (let i = start; i <= end; i++) pages.add(i);
                    }
                } else {
                    const page = Number(trimmed);
                    if (!isNaN(page)) pages.add(page);
                }
            });
            return pages.size > 0 ? pages : null;
        };

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Fallback copy failed', err);
            }
            document.body.removeChild(textArea);
        };

        const getLineContext = (fullText, index) => {
            return "Deprecated in favor of new logic"; 
        };

        // --- FILE PROCESSING ---
        const extractContentFromFile = async (file, useOCR) => {
            const fileType = file.name.split('.').pop().toLowerCase();
            let pages = []; 

            try {
                if (['txt', 'html', 'htm', 'md', 'csv', 'xml', 'json', 'mhtml', 'mht'].includes(fileType)) {
                    const text = await file.text();
                    pages.push({ pageIndex: 1, text: text });
                }
                else if (fileType === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const text = textContent.items.map(item => item.str).join(' ');
                        pages.push({ pageIndex: i, text: text });
                    }
                }
                else if (['png', 'jpg', 'jpeg', 'bmp', 'webp'].includes(fileType)) {
                    if (!useOCR) {
                        pages.push({ pageIndex: 1, text: "[Ảnh: Hãy bật chế độ OCR trong cấu hình để đọc nội dung ảnh]" });
                    } else {
                        try {
                            const worker = await Tesseract.createWorker('vie');
                            const ret = await worker.recognize(file);
                            pages.push({ pageIndex: 1, text: ret.data.text });
                            await worker.terminate();
                        } catch (e) {
                            console.error("OCR Error:", e);
                            pages.push({ pageIndex: 1, text: `[Lỗi OCR: ${e.message}]` });
                        }
                    }
                } else {
                     // Fallback for binary/unsupported
                     pages.push({ pageIndex: 0, text: `[Định dạng .${fileType} chưa hỗ trợ trích xuất nội dung]` });
                     try {
                        // Attempt text read anyway for some formats
                         const text = await file.text();
                         // Simple check if it looks like binary
                         if (/[\x00-\x08\x0E-\x1F]/.test(text.substring(0, 100))) {
                             // Binary detected
                         } else {
                            pages.push({ pageIndex: 1, text: text.substring(0, 2000) + "\n...[File có thể chưa được đọc trọn vẹn]..." });
                         }
                     } catch(e) {}
                }
                return pages;
            } catch (error) {
                console.error("File reading error:", error);
                return [{ pageIndex: 0, text: `[Lỗi đọc file: ${error.message}]` }];
            }
        };

        // --- EXPORT LOGIC ---
        const exportData = async (data, options, setExportStatus) => {
            const { format, selectedCategories } = options;
            const isFullExtract = data.results.some(r => r.categoryId === 'all_content');
            
            let rowsToExport;
            if (isFullExtract) {
                rowsToExport = data.results;
            } else {
                rowsToExport = data.results.filter(r => selectedCategories.includes(r.categoryId));
            }

            if (rowsToExport.length === 0) {
                alert("Không có dữ liệu nào khớp với các mục đã chọn.");
                return;
            }

            const fileName = `Export_${new Date().toISOString().slice(0,10)}`;

            if (format === 'excel') {
                const wsData = rowsToExport.map(r => ({
                    'Mục': r.categoryName,
                    'File': r.fileName,
                    'Trang': r.pageIndex,
                    'Từ khóa': r.keyword,
                    'Nội dung': r.context.replace(/<[^>]*>?/gm, ' ').replace(/\n/g, ' ').trim()
                }));
                const ws = XLSX.utils.json_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            }
            else if (format === 'pdf') {
                if (setExportStatus) setExportStatus("Đang tạo PDF...");
                
                // Simple PDF using jsPDF AutoTable
                // Note: Standard fonts might not support Vietnamese well without custom font loading
                // Here we use a safe default approach
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(16);
                doc.text("Bao cao trich xuat du lieu", 14, 15);
                
                const tableBody = rowsToExport.map(r => [
                    r.categoryName,
                    `${r.fileName} (Trg ${r.pageIndex})`,
                    r.keyword,
                    r.context.replace(/<[^>]*>?/gm, ' ').substring(0, 100) // Truncate for PDF stability
                ]);

                doc.autoTable({
                    head: [['Muc', 'File', 'Tu khoa', 'Noi dung']],
                    body: tableBody,
                    startY: 25,
                    styles: { fontSize: 9 },
                    theme: 'grid'
                });
                
                doc.save(`${fileName}.pdf`);
                if (setExportStatus) setExportStatus(null);
            }
            else if (['word', 'html', 'mhtml'].includes(format)) {
                let htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
                    <head><meta charset='utf-8'><title>Export</title>
                    <style>table{border-collapse:collapse;width:100%;} th,td{border:1px solid #000;padding:5px;} .hl{background:yellow;}</style>
                    </head><body>
                    <h2>Báo cáo trích xuất dữ liệu</h2>
                    <table>
                        <thead><tr style="background:#ddd"><th>Mục</th><th>File/Trang</th><th>Từ khóa</th><th>Nội dung</th></tr></thead>
                        <tbody>
                            ${rowsToExport.map(r => `
                                <tr>
                                    <td>${r.categoryName}</td>
                                    <td>${r.fileName} (Trang ${r.pageIndex})</td>
                                    <td>${r.keyword}</td>
                                    <td>${r.context}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table></body></html>`;
                
                const blob = new Blob(['\ufeff', htmlContent], { type: format === 'word' ? 'application/msword' : 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${fileName}.${format === 'word' ? 'doc' : format}`;
                link.click();
            }
        };

        // --- COMPONENTS ---

        const ExportModal = ({ isOpen, onClose, categories, data, onExport }) => {
            const isFullExtract = data.results.some(r => r.categoryId === 'all_content');
            const displayCategories = isFullExtract 
                ? [{ id: 'all_content', name: 'Toàn bộ nội dung' }]
                : categories;

            const [selectedCats, setSelectedCats] = useState(displayCategories.map(c => c.id));
            const [format, setFormat] = useState('excel');
            const [status, setStatus] = useState(null);

            useEffect(() => {
                if (isOpen) setSelectedCats(displayCategories.map(c => c.id));
            }, [isOpen, categories, isFullExtract]);

            if (!isOpen) return null;

            const toggleCat = (id) => selectedCats.includes(id) ? setSelectedCats(selectedCats.filter(c => c !== id)) : setSelectedCats([...selectedCats, id]);
            const toggleAll = () => setSelectedCats(selectedCats.length === displayCategories.length ? [] : displayCategories.map(c => c.id));

            const handleExportClick = async () => {
                await onExport(format, selectedCats, setStatus);
                if (format !== 'pdf') onClose();
                else setTimeout(onClose, 1000); 
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div className="bg-white rounded-lg p-6 w-96 shadow-xl relative" style={{zIndex: 1000}}>
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="download" /> Xuất dữ liệu</h3>
                        
                        {status && (
                            <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-lg z-10 flex-col gap-2">
                                <Icon name="loader-2" className="animate-spin text-blue-600" size={32} />
                                <span className="text-sm font-medium text-blue-700">{status}</span>
                            </div>
                        )}

                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Định dạng:</label>
                            <select className="w-full border rounded p-2" value={format} onChange={e => setFormat(e.target.value)}>
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="word">Word (.doc)</option>
                                <option value="pdf">PDF (.pdf)</option>
                                <option value="html">HTML (.html)</option>
                            </select>
                        </div>
                        <div className="mb-4 max-h-48 overflow-y-auto border rounded p-2 custom-scroll">
                            <div className="flex justify-between mb-2 pb-2 border-b"><span className="text-sm font-bold">Chọn mục để xuất:</span><button onClick={toggleAll} className="text-xs text-blue-600">Chọn hết</button></div>
                            {displayCategories.map(cat => (
                                <label key={cat.id} className="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" checked={selectedCats.includes(cat.id)} onChange={() => toggleCat(cat.id)} className="rounded text-blue-600" />
                                    <span className="text-sm truncate">{cat.name}</span>
                                </label>
                            ))}
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Hủy</button>
                            <button onClick={handleExportClick} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Xuất Ngay</button>
                        </div>
                    </div>
                </div>
            );
        };

        const FileLibrary = ({ files, onToggle, onDelete, onDrop, onUpdatePageRange }) => {
            const fileInputRef = useRef(null);
            const [dragActive, setDragActive] = useState(false);

            const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); if (e.type === "dragenter" || e.type === "dragover") setDragActive(true); else if (e.type === "dragleave") setDragActive(false); };
            const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(false); if (e.dataTransfer.files && e.dataTransfer.files[0]) onDrop(e.dataTransfer.files); };
            const handleFileSelect = (e) => { if (e.target.files && e.target.files[0]) onDrop(e.target.files); };

            const selectedCount = files.filter(f => f.selected).length;

            return (
                <div 
                    className="flex flex-col h-full bg-white rounded-lg shadow-sm border relative" 
                    onDragEnter={handleDrag} 
                    onDragOver={handleDrag} 
                    onDrop={handleDrop}
                >
                    {dragActive && (
                        <div 
                            className="absolute inset-0 bg-blue-50 bg-opacity-95 z-50 flex flex-col items-center justify-center rounded-lg border-2 border-blue-500 border-dashed animate-pulse" 
                            onDragLeave={handleDrag} 
                            onDragOver={handleDrag} 
                            onDrop={handleDrop}
                        >
                            <Icon name="upload-cloud" size={48} className="text-blue-600 mb-2 pointer-events-none" />
                            <span className="text-lg font-bold text-blue-700 pointer-events-none">Thả file vào đây để thêm</span>
                        </div>
                    )}
                    <div className="p-3 border-b flex justify-between items-center bg-gray-50">
                        <div className="font-bold text-gray-700 flex items-center gap-2"><Icon name="files" size={16} /> Thư viện File <span className="text-xs font-normal bg-gray-200 px-2 py-0.5 rounded-full">{files.length}</span></div>
                        <div className="flex gap-2">
                            <button onClick={() => fileInputRef.current.click()} className="p-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors" title="Thêm file"><Icon name="plus" size={16} /></button>
                            <input type="file" ref={fileInputRef} onChange={handleFileSelect} className="hidden" multiple />
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                        {files.length === 0 ? (
                            <div className="text-center text-gray-400 mt-10 text-sm">Chưa có file nào.<br/>Kéo thả hoặc nhấn + để thêm.</div>
                        ) : (
                            files.map(file => (
                                <div key={file.id} className={`flex items-center gap-2 p-2 rounded border text-sm group ${file.selected ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-transparent opacity-70'}`}>
                                    <input type="checkbox" checked={file.selected} onChange={() => onToggle(file.id)} className="rounded text-blue-600 cursor-pointer flex-shrink-0" />
                                    <div className="flex-1 min-w-0 grid grid-cols-12 gap-2 items-center">
                                        <div className="col-span-7">
                                            <div className="truncate font-medium text-gray-700" title={file.name}>{file.name}</div>
                                            <div className="text-[10px] text-gray-500 uppercase">{file.type} • {file.pages?.length || 0} trang</div>
                                        </div>
                                        <div className="col-span-5 relative">
                                             <label className="block text-[8px] text-gray-400 absolute -top-1.5 left-1 bg-white px-0.5">Trang:</label>
                                             <input 
                                                type="text" 
                                                placeholder="Tất cả"
                                                title="Nhập trang (VD: 1,3,5-10). Để trống = Tất cả"
                                                className="w-full text-xs border rounded px-1 py-1 bg-white focus:ring-1 focus:ring-blue-500 outline-none text-gray-700 text-center placeholder:text-gray-300"
                                                value={file.pageRange || ''}
                                                onChange={(e) => onUpdatePageRange(file.id, e.target.value)}
                                                onClick={(e) => e.stopPropagation()}
                                            />
                                        </div>
                                    </div>
                                    <button onClick={() => onDelete(file.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"><Icon name="trash-2" size={14} /></button>
                                </div>
                            ))
                        )}
                    </div>
                    <div className="p-2 bg-yellow-50 text-[10px] text-yellow-800 border-t flex items-center gap-1">
                        <Icon name="info" size={12} />
                        <span>Bỏ tích tất cả để trích xuất toàn bộ file.</span>
                    </div>
                </div>
            );
        };

        const CategoryManager = ({ categories, onChange }) => {
            const addCat = () => onChange([...categories, { id: generateId(), name: `Mục ${categories.length + 1}`, keywords: '', active: true }]);
            const updateCat = (id, field, val) => onChange(categories.map(c => c.id === id ? { ...c, [field]: val } : c));
            const removeCat = (id) => onChange(categories.filter(c => c.id !== id));

            return (
                <div className="flex flex-col h-full bg-white rounded-lg shadow-sm border">
                    <div className="p-3 border-b flex justify-between items-center bg-gray-50">
                        <div className="font-bold text-gray-700 flex items-center gap-2"><Icon name="list" size={16} /> Cấu trúc trích xuất</div>
                        <button onClick={addCat} className="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1"><Icon name="plus-circle" size={14} /> Thêm mục</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scroll">
                        {categories.map((cat, idx) => (
                            <div key={cat.id} className="border rounded p-3 bg-gray-50 relative group hover:shadow-md transition-shadow">
                                <div className="flex items-center gap-2 mb-2">
                                    <input type="checkbox" checked={cat.active !== false} onChange={(e) => updateCat(cat.id, 'active', e.target.checked)} className="rounded text-blue-600" title="Bật/Tắt mục này" />
                                    <input type="text" value={cat.name} onChange={(e) => updateCat(cat.id, 'name', e.target.value)} className="flex-1 font-bold text-sm bg-transparent border-b border-dashed border-gray-300 focus:border-blue-500 outline-none" placeholder="Tên mục (VD: Họ tên)" />
                                    <button onClick={() => removeCat(cat.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icon name="x" size={14} /></button>
                                </div>
                                <textarea 
                                    value={cat.keywords} 
                                    onChange={(e) => updateCat(cat.id, 'keywords', e.target.value)} 
                                    className="w-full text-xs p-2 border rounded resize-none h-16 focus:ring-1 focus:ring-blue-500 outline-none" 
                                    placeholder="Nhập từ khóa ngăn cách bởi dấu phẩy (VD: Ông, Bà, Fullname)..." 
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const EditableCell = ({ content, keyword, onSave }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [value, setValue] = useState("");

            const startEditing = () => {
                const plainText = content.replace(/<[^>]*>?/gm, '');
                setValue(plainText);
                setIsEditing(true);
            };

            const save = () => {
                setIsEditing(false);
                if (value !== content.replace(/<[^>]*>?/gm, '')) {
                    onSave(value); 
                }
            };

            if (isEditing) {
                return (
                    <div className="editing h-full min-h-[60px]">
                        <textarea 
                            autoFocus 
                            value={value} 
                            onChange={(e) => setValue(e.target.value)} 
                            onBlur={save}
                            onKeyDown={(e) => { if(e.key === 'Escape') setIsEditing(false); }}
                        />
                    </div>
                );
            }

            return (
                <div 
                    className="max-h-64 overflow-y-auto custom-scroll editable-cell p-1 rounded transition-colors relative" 
                    onDoubleClick={startEditing}
                    title="Double-click để sửa nội dung"
                >
                    <div dangerouslySetInnerHTML={{ __html: content.replace(new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<span class="highlight">$1</span>') }} />
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [tabs, setTabs] = useState(() => {
                const saved = localStorage.getItem('extractor_v4_data');
                const defaultData = [{ 
                    id: 'default', 
                    name: 'Dự án mẫu', 
                    categories: [
                        { id: 'c1', name: 'Email', keywords: 'email, @, mail', active: true },
                        { id: 'c2', name: 'Số điện thoại', keywords: 'sđt, hotline, tel, phone', active: true }
                    ], 
                    library: [], 
                    results: [],
                    settings: { useOCR: false, caseSensitive: false, textTransform: 'none' }
                }];
                if (saved) {
                    try { return JSON.parse(saved); } catch(e) { return defaultData; }
                }
                return defaultData;
            });

            const [activeTabId, setActiveTabId] = useState(() => {
                const savedId = localStorage.getItem('extractor_v4_active_tab');
                if (savedId && tabs.some(t => t.id === savedId)) return savedId;
                return tabs[0]?.id || 'default';
            });

            const [processing, setProcessing] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [exportModalOpen, setExportModalOpen] = useState(false);

            useEffect(() => { localStorage.setItem('extractor_v4_data', JSON.stringify(tabs)); }, [tabs]);
            useEffect(() => { localStorage.setItem('extractor_v4_active_tab', activeTabId); }, [activeTabId]);

            const updateTab = (id, newData) => setTabs(tabs.map(t => t.id === id ? { ...newData } : t));
            
            const addTab = () => {
                const currentTab = tabs.find(t => t.id === activeTabId) || tabs[0];
                const newId = generateId();
                const initialCategories = currentTab ? currentTab.categories.map(c => ({...c, id: generateId()})) : [];
                const initialSettings = currentTab ? {...currentTab.settings} : { useOCR: false, caseSensitive: false, textTransform: 'none' };

                setTabs([...tabs, { 
                    id: newId, 
                    name: `Dự án ${tabs.length+1}`, 
                    categories: initialCategories, 
                    library: [], 
                    results: [],
                    settings: initialSettings
                }]);
                setActiveTabId(newId);
            };
            
            const activeTab = tabs.find(t => t.id === activeTabId) || tabs[0];
            const data = activeTab;
            const tabId = activeTab.id;

            const handleFileUpload = async (fileList) => {
                setProcessing(true);
                const newFiles = [];
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    const pages = await extractContentFromFile(file, data.settings.useOCR);
                    newFiles.push({ 
                        id: generateId(), 
                        name: file.name, 
                        type: file.name.split('.').pop(), 
                        pages: pages,
                        selected: true,
                        pageRange: "" 
                    });
                }
                const updatedLibrary = [...data.library, ...newFiles];
                updateTab(tabId, { ...data, library: updatedLibrary });
                setProcessing(false);
            };

            const toggleFile = (id) => {
                const updatedLib = data.library.map(f => f.id === id ? { ...f, selected: !f.selected } : f);
                updateTab(tabId, { ...data, library: updatedLib });
            };

            const deleteFile = (id) => {
                if(!confirm("Bạn có chắc muốn xóa file này?")) return;
                const updatedLib = data.library.filter(f => f.id !== id);
                updateTab(tabId, { ...data, library: updatedLib });
            };

            const handlePageRangeUpdate = (fileId, newRange) => {
                const updatedLib = data.library.map(f => f.id === fileId ? { ...f, pageRange: newRange } : f);
                updateTab(tabId, { ...data, library: updatedLib });
            };

            const handleResultEdit = (resultId, newContext) => {
                const updatedResults = data.results.map(r => r.id === resultId ? { ...r, context: newContext } : r);
                updateTab(tabId, { ...data, results: updatedResults });
            };

            // Smart Transform Effect
            useEffect(() => {
                if (data.results.length > 0) {
                    const updatedResults = data.results.map(r => ({
                        ...r,
                        context: transformHtmlContent(r.context, data.settings.textTransform),
                        fullContent: applyTextTransform(r.fullContent, data.settings.textTransform)
                    }));
                    updateTab(tabId, { ...data, results: updatedResults });
                }
            }, [data.settings.textTransform]);

            const runExtraction = () => {
                setProcessing(true);
                let activeCategories = data.categories.filter(c => c.active !== false);
                
                if (activeCategories.length === 0) {
                     // Nếu không chọn mục nào, coi như trích xuất toàn bộ (Full Extract)
                    activeCategories = [{ id: 'all_content', name: 'Toàn bộ nội dung', keywords: null }];
                }

                let newResults = [];
                const activeFiles = data.library.filter(f => f.selected);

                if (activeFiles.length === 0) {
                     alert("Vui lòng chọn ít nhất một file để xử lý.");
                     setProcessing(false);
                     return;
                }

                setTimeout(() => {
                    try {
                        activeFiles.forEach(fileData => {
                            const allowedPages = parsePageRange(fileData.pageRange);
                            
                            fileData.pages.forEach(page => {
                                if (allowedPages && typeof page.pageIndex === 'number' && !allowedPages.has(page.pageIndex)) {
                                    return;
                                }

                                activeCategories.forEach(cat => {
                                    if (cat.keywords === null) {
                                        // Full extract
                                        const transformedText = applyTextTransform(page.text, data.settings.textTransform);
                                        newResults.push({
                                            id: generateId(),
                                            fileName: fileData.name,
                                            fileType: fileData.type,
                                            categoryName: cat.name,
                                            categoryId: cat.id,
                                            keyword: "(Toàn bộ)",
                                            context: transformedText,
                                            fullContent: transformedText,
                                            pageIndex: page.pageIndex,
                                            date: new Date().toLocaleString()
                                        });
                                    } else {
                                        let searchTerms = [cat.name];
                                        if (cat.keywords && cat.keywords.trim() !== "") {
                                            searchTerms = cat.keywords.split(',').map(k => k.trim()).filter(k => k);
                                        }
                                        searchTerms.forEach(term => {
                                            const flags = data.settings.caseSensitive ? 'g' : 'gi';
                                            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
                                            let match, matchCount = 0;
                                            while ((match = regex.exec(page.text)) !== null && matchCount < 100) {
                                                const lines = page.text.split('\n');
                                                let currentPos = 0, targetLineIndex = -1;
                                                for (let i = 0; i < lines.length; i++) {
                                                    const lineLen = lines[i].length + 1; 
                                                    if (match.index >= currentPos && match.index < currentPos + lineLen) { targetLineIndex = i; break; }
                                                    currentPos += lineLen;
                                                }
                                                
                                                let contextStr = "";
                                                if (targetLineIndex !== -1) {
                                                    const startLine = Math.max(0, targetLineIndex - 2);
                                                    const endLine = Math.min(lines.length, targetLineIndex + 3);
                                                    contextStr = lines.slice(startLine, endLine).map((line, idx) => {
                                                        const isTarget = (startLine + idx) === targetLineIndex;
                                                        const tLine = applyTextTransform(line, data.settings.textTransform);
                                                        return isTarget ? `<span class="target-line">${tLine}</span>` : `<span class="context-line">${tLine}</span>`;
                                                    }).join('\n');
                                                }

                                                newResults.push({
                                                    id: generateId(),
                                                    fileName: fileData.name,
                                                    fileType: fileData.type,
                                                    categoryName: cat.name,
                                                    categoryId: cat.id,
                                                    keyword: term,
                                                    context: contextStr,
                                                    fullContent: page.text,
                                                    pageIndex: page.pageIndex,
                                                    date: new Date().toLocaleString()
                                                });
                                                matchCount++;
                                            }
                                        });
                                    }
                                });
                            });
                        });
                        updateTab(tabId, { ...data, results: newResults });
                        alert(`Đã trích xuất xong! Tìm thấy ${newResults.length} kết quả.`);
                    } catch (err) {
                        console.error(err);
                        alert("Có lỗi xảy ra trong quá trình xử lý.");
                    }
                    setProcessing(false);
                }, 100);
            };

            const filteredGroups = useMemo(() => {
                const groups = {};
                data.results.forEach(r => {
                    if (searchTerm && !r.context.toLowerCase().includes(searchTerm.toLowerCase()) && !r.fileName.toLowerCase().includes(searchTerm.toLowerCase())) return;
                    if (!groups[r.categoryName]) groups[r.categoryName] = [];
                    groups[r.categoryName].push(r);
                });
                return groups;
            }, [data.results, searchTerm]);

            const handleCopyData = () => {
                let textToCopy = "";
                Object.keys(filteredGroups).forEach(catName => {
                    filteredGroups[catName].forEach(row => {
                        const cleanContext = row.context.replace(/<[^>]*>?/gm, '').replace(/\n/g, ' ').trim();
                        if (cleanContext) textToCopy += `${cleanContext}\n`;
                    });
                });
                if (!textToCopy) return alert("Không có dữ liệu để sao chép.");
                copyToClipboard(textToCopy);
                alert("Đã sao chép cột 'Nội dung' vào Clipboard!");
            };

            return (
                <div className="flex h-screen w-full flex-col">
                    {/* Header */}
                    <div className="h-12 bg-white border-b flex items-center px-4 justify-between shrink-0 shadow-sm z-10">
                        <div className="flex items-center gap-2 font-bold text-blue-700 text-lg">
                            <Icon name="database" /> Super Data Extractor <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">v4.17</span>
                        </div>
                        <div className="flex items-center gap-2 overflow-x-auto custom-scroll max-w-[50%]">
                            {tabs.map(t => (
                                <button key={t.id} onClick={() => setActiveTabId(t.id)} className={`px-3 py-1 rounded text-xs font-medium whitespace-nowrap transition-colors flex items-center gap-1 ${activeTabId === t.id ? 'bg-blue-600 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {t.name}
                                    {tabs.length > 1 && <span onClick={(e) => { e.stopPropagation(); if(confirm("Xóa dự án này?")) setTabs(tabs.filter(x => x.id !== t.id)); }} className="hover:text-red-300 ml-1">×</span>}
                                </button>
                            ))}
                            <button onClick={addTab} className="p-1 rounded bg-gray-100 hover:bg-gray-200"><Icon name="plus" size={14} /></button>
                        </div>
                        <div className="text-xs text-gray-400">Chạy cục bộ trên trình duyệt</div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 overflow-hidden relative">
                         <ExportModal isOpen={exportModalOpen} onClose={() => setExportModalOpen(false)} categories={data.categories} data={data} onExport={(fmt, cats, setSts) => exportData(data, {format: fmt, selectedCategories: cats}, setSts)} />

                        <div className="h-full flex flex-col p-4 gap-4 overflow-hidden">
                            {/* Top Section: Config & Library */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 h-[45vh] min-h-[450px] shrink-0">
                                {/* Categories (3/12) */}
                                <div className="lg:col-span-3 h-full overflow-hidden">
                                    <CategoryManager categories={data.categories} onChange={(newCats) => updateTab(tabId, { ...data, categories: newCats })} />
                                </div>
                                
                                {/* Library (5/12) */}
                                <div className="lg:col-span-5 h-full overflow-hidden">
                                    <FileLibrary files={data.library} onToggle={toggleFile} onDelete={deleteFile} onDrop={handleFileUpload} onUpdatePageRange={handlePageRangeUpdate} />
                                </div>

                                {/* Controls (4/12) */}
                                <div className="lg:col-span-4 h-full bg-white rounded-lg shadow-sm border p-4 flex flex-col gap-4 overflow-y-auto custom-scroll">
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 shrink-0">
                                        <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm"><Icon name="settings" size={16} /> Cấu hình Xử lý</h3>
                                        <div className="space-y-3">
                                            <label className="flex items-center justify-between cursor-pointer p-2 hover:bg-white rounded transition-colors">
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-medium text-gray-700">Chế độ OCR (Ảnh)</span>
                                                    <span className="text-[10px] text-gray-400">Dùng Tesseract đọc chữ trong ảnh (Chậm)</span>
                                                </div>
                                                <input type="checkbox" checked={data.settings.useOCR} onChange={(e) => updateTab(tabId, { ...data, settings: { ...data.settings, useOCR: e.target.checked } })} className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                            </label>
                                            <div className="h-px bg-gray-200"></div>
                                            <label className="flex items-center justify-between cursor-pointer p-2 hover:bg-white rounded transition-colors">
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-medium text-gray-700">Phân biệt Hoa/Thường</span>
                                                    <span className="text-[10px] text-gray-400">Chính xác từng ký tự (Case Sensitive)</span>
                                                </div>
                                                <input type="checkbox" checked={data.settings.caseSensitive} onChange={(e) => updateTab(tabId, { ...data, settings: { ...data.settings, caseSensitive: e.target.checked } })} className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                            </label>
                                            <div className="h-px bg-gray-200"></div>
                                            <div className="flex flex-col gap-2 opacity-90">
                                                <span className="text-sm font-medium text-gray-700 px-2">Định dạng kết quả (Tự động):</span>
                                                <select className="w-full text-sm border rounded p-2 bg-white outline-none focus:ring-1 focus:ring-blue-500" value={data.settings.textTransform || 'none'} onChange={(e) => updateTab(tabId, { ...data, settings: { ...data.settings, textTransform: e.target.value } })}>
                                                    <option value="none">Giữ nguyên bản gốc</option>
                                                    <option value="uppercase">CHỮ HOA TOÀN BỘ</option>
                                                    <option value="lowercase">chữ thường toàn bộ</option>
                                                    <option value="sentence_case">Chữ hoa đầu câu</option>
                                                    <option value="no_accent_upper">CHỮ HOA KHÔNG DẤU</option>
                                                    <option value="no_accent_upper_alpha">HOA KHÔNG DẤU (CHỈ LẤY CHỮ)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 shrink-0 text-xs text-blue-800 space-y-2">
                                        <h3 className="font-bold flex items-center gap-2"><Icon name="activity" size={14} /> Trạng thái</h3>
                                        <div className="flex justify-between"><span>File đã chọn:</span><span className="font-bold">{data.library.filter(f => f.selected).length}</span></div>
                                        <div className="flex justify-between"><span>Kết quả hiện tại:</span><span className="font-bold">{data.results.length}</span></div>
                                    </div>

                                    <div className="shrink-0 mt-auto pb-1">
                                        {processing ? (
                                            <button disabled className="w-full py-3 bg-gray-100 text-gray-400 rounded font-bold flex items-center justify-center gap-2 cursor-wait"><Icon name="loader-2" className="animate-spin" /> Đang xử lý...</button>
                                        ) : (
                                            <button onClick={runExtraction} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow-md transform active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="play" /> BẮT ĐẦU QUÉT</button>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Bottom Section: Results */}
                            <div className="flex-1 flex flex-col bg-white rounded-lg shadow-sm border overflow-hidden min-h-0">
                                <div className="p-3 border-b flex items-center justify-between gap-4 bg-gray-50 shrink-0">
                                    <div className="flex items-center gap-2 flex-1 max-w-sm bg-white border rounded px-3 py-1.5 shadow-sm focus-within:ring-2 ring-blue-100">
                                        <Icon name="search" size={16} className="text-gray-400" />
                                        <input type="text" placeholder="Tìm kiếm trong kết quả..." className="bg-transparent outline-none text-sm w-full" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        <div className="flex items-center gap-1 bg-white border rounded px-2 py-1 shadow-sm" title="Chuyển đổi định dạng kết quả nhanh">
                                            <Icon name="type" size={16} className="text-blue-600" />
                                            <select 
                                                className="text-xs font-medium bg-transparent outline-none text-gray-700 cursor-pointer min-w-[100px]"
                                                value={data.settings.textTransform || 'none'}
                                                onChange={(e) => updateTab(tabId, { ...data, settings: { ...data.settings, textTransform: e.target.value } })}
                                            >
                                                <option value="none">Giữ nguyên</option>
                                                <option value="uppercase">CHỮ HOA</option>
                                                <option value="lowercase">chữ thường</option>
                                                <option value="sentence_case">Hoa đầu câu</option>
                                                <option value="no_accent_upper">HOA KHÔNG DẤU</option>
                                            </select>
                                        </div>

                                        <button onClick={handleCopyData} className="p-2 hover:bg-blue-100 text-blue-600 rounded flex items-center gap-1 text-sm font-medium" title="Copy cột NỘI DUNG vào Clipboard"><Icon name="copy" size={16} /></button>
                                        <button onClick={() => updateTab(tabId, {...data, results: []})} className="p-2 hover:bg-red-100 text-red-600 rounded flex items-center gap-1 text-sm font-medium" title="Xóa toàn bộ kết quả"><Icon name="trash-2" size={16} /></button>
                                        <div className="h-6 w-px bg-gray-300 mx-1"></div>
                                        <button onClick={() => setExportModalOpen(true)} className="flex items-center gap-1 px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-bold shadow-sm transition-colors"><Icon name="download" size={16} /> Xuất Báo Cáo</button>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-auto bg-gray-50 p-4 custom-scroll">
                                    {Object.keys(filteredGroups).length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                                            <Icon name="inbox" size={48} />
                                            <p className="mt-2 text-sm">Chưa có kết quả nào.</p>
                                        </div>
                                    ) : (
                                        Object.entries(filteredGroups).map(([catName, rows]) => (
                                            <div key={catName} className="mb-6 bg-white rounded-lg shadow-sm border overflow-hidden">
                                                <div className="bg-blue-50 px-4 py-2 border-b flex justify-between items-center">
                                                    <h3 className="font-bold text-blue-800 flex items-center gap-2">
                                                        <Icon name="folder" size={16} /> {catName} 
                                                        <span className="text-xs font-normal bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">{rows.length}</span>
                                                    </h3>
                                                    <span className="text-[10px] text-gray-400 italic">Double-click nội dung để sửa.</span>
                                                </div>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-left text-sm">
                                                        <thead className="bg-gray-50 text-gray-600 font-medium border-b text-xs uppercase">
                                                            <tr><th className="p-3 w-48">Nguồn File</th><th className="p-3 w-32">Từ khóa</th><th className="p-3">Ngữ cảnh</th></tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {rows.map(row => (
                                                                <tr key={row.id} className="hover:bg-gray-50 group">
                                                                    <td className="p-3 align-top">
                                                                        <div className="font-medium text-gray-800 truncate max-w-[12rem]" title={row.fileName}>{row.fileName}</div>
                                                                        <div className="text-[10px] text-gray-400">Trang {row.pageIndex}</div>
                                                                    </td>
                                                                    <td className="p-3 align-top"><span className="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs border inline-block">{row.keyword}</span></td>
                                                                    <td className="p-3 text-gray-600 text-xs font-mono whitespace-pre-wrap bg-gray-50 rounded m-2 border">
                                                                        <EditableCell content={row.context} keyword={row.keyword} onSave={(newVal) => handleResultEdit(row.id, newVal)} />
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

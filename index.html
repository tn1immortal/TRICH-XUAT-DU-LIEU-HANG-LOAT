<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Data Extractor Pro v4.3 (OCR Enabled)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Libraries for File Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Tesseract OCR (v4) -->
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .highlight { background-color: #fde047; padding: 0 2px; border-radius: 2px; font-weight: 500; border-bottom: 2px solid #eab308; }
        .context-line { display: block; min-height: 1.2em; }
        .target-line { background-color: #fffbeb; font-weight: 500; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if (className) i.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex' }}></span>;
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- FILE PROCESSING ---
        const extractContentFromFile = async (file, useOCR) => {
            const fileType = file.name.split('.').pop().toLowerCase();
            let pages = []; 

            try {
                if (['txt', 'html', 'htm', 'md', 'csv', 'xml', 'json'].includes(fileType)) {
                    const text = await file.text();
                    pages.push({ pageIndex: 1, text: text });
                }
                else if (fileType === 'docx') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    pages.push({ pageIndex: 1, text: result.value });
                }
                else if (['xls', 'xlsx'].includes(fileType)) {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    workbook.SheetNames.forEach((sheetName) => {
                        const rowObject = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                        const text = rowObject.map(row => row.join(" ")).join("\n");
                        pages.push({ pageIndex: `Sheet: ${sheetName}`, text: text });
                    });
                }
                else if (fileType === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdf = await loadingTask.promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const text = content.items.map(item => item.str).join(" ");
                        pages.push({ pageIndex: i, text: text });
                    }
                }
                else if (['png', 'jpg', 'jpeg', 'bmp', 'webp'].includes(fileType)) {
                    if (!useOCR) {
                        pages.push({ pageIndex: 1, text: "[Ảnh: Hãy bật chế độ OCR trong cấu hình để đọc nội dung ảnh]" });
                    } else {
                        // Tesseract v4 Logic
                        try {
                            const worker = await Tesseract.createWorker();
                            await worker.loadLanguage('vie');
                            await worker.initialize('vie');
                            const ret = await worker.recognize(file);
                            await worker.terminate();
                            pages.push({ pageIndex: 1, text: ret.data.text });
                        } catch (ocrErr) {
                            console.error("OCR Error:", ocrErr);
                            pages.push({ pageIndex: 1, text: `[Lỗi OCR: ${ocrErr.message}]` });
                        }
                    }
                } else {
                    pages.push({ pageIndex: 0, text: `[Định dạng .${fileType} chưa hỗ trợ]` });
                }
                return pages;
            } catch (error) {
                console.error(error);
                return [{ pageIndex: 0, text: `Lỗi đọc file: ${error.message}` }];
            }
        };

        // --- EXPORT LOGIC ---
        const exportData = (data, options) => {
            const { format, selectedCategories } = options;
            const rowsToExport = data.results.filter(r => selectedCategories.includes(r.categoryId));
            
            if (rowsToExport.length === 0) {
                alert("Không có dữ liệu nào khớp với các mục đã chọn.");
                return;
            }
            const fileName = `Export_${new Date().toISOString().slice(0,10)}`;

            if (format === 'excel') {
                const flatRows = rowsToExport.map(r => ({
                    Category: r.categoryName,
                    FileName: r.fileName,
                    Page: r.pageIndex,
                    Keyword: r.keyword,
                    Context: r.context.replace(/<[^>]*>?/gm, ' ').replace(/\n/g, ' '),
                    Date: r.date
                }));
                const worksheet = XLSX.utils.json_to_sheet(flatRows);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
                XLSX.writeFile(workbook, `${fileName}.xlsx`);
            }
            else if (format === 'word' || format === 'html') {
                let htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
                    <head><meta charset='utf-8'><title>Export</title>
                    <style>
                        body { font-family: 'Times New Roman'; } table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #000; padding: 8px; vertical-align: top; text-align: left; }
                        th { background-color: #f2f2f2; } .highlight { background-color: yellow; }
                    </style></head><body>
                    <h2>Báo cáo trích xuất dữ liệu</h2>
                    <table><thead><tr><th>File/Trang</th><th>Từ khóa</th><th>Nội dung</th></tr></thead><tbody>
                `;
                const groups = {};
                rowsToExport.forEach(r => { if (!groups[r.categoryName]) groups[r.categoryName] = []; groups[r.categoryName].push(r); });
                Object.keys(groups).forEach(cat => {
                    htmlContent += `<tr style="background:#e0f2fe;font-weight:bold"><td colspan="3">${cat}</td></tr>`;
                    groups[cat].forEach(r => {
                        htmlContent += `<tr><td>${r.fileName}<br/><small>Trang ${r.pageIndex}</small></td><td>${r.keyword}</td><td>${r.context}</td></tr>`;
                    });
                });
                htmlContent += `</tbody></table></body></html>`;
                const blob = new Blob([htmlContent], { type: format === 'word' ? 'application/msword' : 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${fileName}.${format === 'word' ? 'doc' : 'html'}`;
                link.click();
            }
        };

        // --- COMPONENTS ---

        const ExportModal = ({ isOpen, onClose, categories, data, onExport }) => {
            if (!isOpen) return null;
            const [selectedCats, setSelectedCats] = useState(categories.map(c => c.id));
            const [format, setFormat] = useState('excel');
            const toggleCat = (id) => selectedCats.includes(id) ? setSelectedCats(selectedCats.filter(c => c !== id)) : setSelectedCats([...selectedCats, id]);
            const toggleAll = () => setSelectedCats(selectedCats.length === categories.length ? [] : categories.map(c => c.id));

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div className="bg-white rounded-lg p-6 w-96 shadow-xl">
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="download" /> Xuất dữ liệu</h3>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Định dạng:</label>
                            <select className="w-full border rounded p-2" value={format} onChange={e => setFormat(e.target.value)}>
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="word">Word (.doc)</option>
                                <option value="html">HTML / Web</option>
                            </select>
                        </div>
                        <div className="mb-4 max-h-48 overflow-y-auto border rounded p-2 custom-scroll">
                            <div className="flex justify-between mb-2 pb-2 border-b"><span className="text-sm font-bold">Chọn mục để xuất:</span><button onClick={toggleAll} className="text-xs text-blue-600">Toggle All</button></div>
                            {categories.map(cat => (
                                <label key={cat.id} className="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" checked={selectedCats.includes(cat.id)} onChange={() => toggleCat(cat.id)} className="rounded text-blue-600" />
                                    <span className="text-sm truncate">{cat.name}</span>
                                    <span className="text-xs text-gray-400 ml-auto">({data.results.filter(r => r.categoryId === cat.id).length})</span>
                                </label>
                            ))}
                        </div>
                        <div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 hover:bg-gray-100 rounded">Hủy</button><button onClick={() => onExport(format, selectedCats)} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" disabled={selectedCats.length === 0}>Xuất File</button></div>
                    </div>
                </div>
            );
        };

        const FileLibrary = ({ files, onToggle, onDelete, onDrop }) => {
            const fileInputRef = useRef(null);
            const [dragActive, setDragActive] = useState(false);

            const handleDrag = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") setDragActive(true);
                else if (e.type === "dragleave") setDragActive(false);
            };

            const handleDrop = (e) => {
                e.preventDefault(); e.stopPropagation(); setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) onDrop(Array.from(e.dataTransfer.files));
            };

            const selectedCount = files.filter(f => f.selected).length;

            return (
                <div className="flex flex-col h-full bg-white rounded-lg shadow-sm border relative" onDragEnter={handleDrag}>
                    {dragActive && (
                        <div className="absolute inset-0 bg-blue-50 bg-opacity-95 z-50 flex flex-col items-center justify-center rounded-lg border-2 border-blue-500 border-dashed animate-pulse" onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}>
                            <Icon name="upload-cloud" size={48} className="text-blue-600 mb-2" />
                            <span className="text-lg font-bold text-blue-700">Thả file vào đây để thêm</span>
                        </div>
                    )}
                    <div className="p-3 border-b flex justify-between items-center bg-gray-50">
                        <div className="flex items-center gap-2"><Icon name="library" size={16} className="text-blue-600" /><span className="font-bold text-sm text-gray-700">Thư viện File ({selectedCount}/{files.length})</span></div>
                        <button onClick={() => fileInputRef.current.click()} className="text-blue-600 hover:bg-blue-100 p-1 rounded" title="Thêm file"><Icon name="plus" size={18} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll">
                        {files.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-60"><Icon name="file-question" size={32} /><p className="text-xs mt-2 text-center">Thư viện trống.<br/>Kéo thả file vào đây.</p></div>
                        ) : (
                            files.map(file => (
                                <div key={file.id} className={`flex items-center gap-2 p-2 rounded border text-sm group ${file.selected ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-transparent opacity-70'}`}>
                                    <input type="checkbox" checked={file.selected} onChange={() => onToggle(file.id)} className="rounded text-blue-600 cursor-pointer" />
                                    <div className="flex-1 min-w-0"><div className="truncate font-medium text-gray-700" title={file.name}>{file.name}</div><div className="text-[10px] text-gray-500 uppercase">{file.type} • {file.pages?.length || 0} trang</div></div>
                                    <button onClick={() => onDelete(file.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14} /></button>
                                </div>
                            ))
                        )}
                    </div>
                    <div className="p-3 border-t bg-gray-50 hover:bg-gray-100 cursor-pointer text-center transition-colors" onClick={() => fileInputRef.current.click()}>
                        <input ref={fileInputRef} type="file" multiple className="hidden" onChange={(e) => e.target.files[0] && onDrop(Array.from(e.target.files))} />
                        <div className="flex items-center justify-center gap-2 text-gray-500 text-xs font-medium"><Icon name="upload" size={14} /><span>Click để chọn file...</span></div>
                    </div>
                </div>
            );
        };

        const CategoryManager = ({ categories, onChange }) => {
            const addCategory = () => onChange([...categories, { id: generateId(), name: `Mục mới`, keywords: "", active: true }]);
            const updateCategory = (id, field, value) => onChange(categories.map(c => c.id === id ? { ...c, [field]: value } : c));
            const removeCategory = (id) => onChange(categories.filter(c => c.id !== id));
            
            const toggleActive = (id) => onChange(categories.map(c => c.id === id ? { ...c, active: !c.active } : c));
            
            const allActive = categories.length > 0 && categories.every(c => c.active !== false);
            const toggleAll = () => {
                const newState = !allActive;
                onChange(categories.map(c => ({ ...c, active: newState })));
            };

            return (
                <div className="space-y-2 h-full flex flex-col bg-white rounded-lg shadow-sm border">
                    <div className="p-3 border-b bg-gray-50 flex items-center justify-between">
                        <span className="font-bold text-sm text-gray-700 flex items-center gap-2"><Icon name="list-checks" size={16} /> Cấu trúc trích xuất</span>
                        <div className="flex items-center gap-2">
                            <label className="flex items-center gap-1 text-[10px] text-blue-600 font-bold cursor-pointer hover:bg-blue-50 px-2 py-1 rounded">
                                <input type="checkbox" checked={allActive} onChange={toggleAll} className="rounded text-blue-600" />
                                All
                            </label>
                            <button onClick={addCategory} className="text-blue-600 hover:bg-blue-100 p-1 rounded" title="Thêm mục"><Icon name="plus" size={18} /></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                        {categories.map((cat, idx) => (
                            <div key={cat.id} className={`flex gap-2 items-start p-2 rounded border group transition-all duration-200 ${cat.active !== false ? 'bg-white border-blue-200 shadow-sm ring-1 ring-blue-50' : 'bg-gray-50 border-gray-100 opacity-60 grayscale'}`}>
                                <div className="pt-2">
                                    <input 
                                        type="checkbox" 
                                        checked={cat.active !== false} 
                                        onChange={() => toggleActive(cat.id)}
                                        className="w-4 h-4 rounded text-blue-600 cursor-pointer"
                                        title="Bật/Tắt mục này"
                                    />
                                </div>
                                <div className="flex-1 space-y-1">
                                    <input 
                                        type="text" placeholder="Tên mục (VD: Cửa)" 
                                        className={`w-full text-sm font-bold bg-transparent border-b border-dashed focus:border-solid outline-none pb-1 ${cat.active !== false ? 'border-gray-300 focus:border-blue-500' : 'border-transparent cursor-not-allowed'}`}
                                        value={cat.name} onChange={(e) => updateCategory(cat.id, 'name', e.target.value)}
                                        disabled={cat.active === false}
                                    />
                                    <input 
                                        type="text" placeholder="Từ khóa (phẩy để tách)..." 
                                        className={`w-full text-xs bg-transparent outline-none placeholder-gray-400 ${cat.active !== false ? 'text-gray-600' : 'text-gray-400 cursor-not-allowed'}`}
                                        value={cat.keywords} onChange={(e) => updateCategory(cat.id, 'keywords', e.target.value)}
                                        disabled={cat.active === false}
                                    />
                                </div>
                                <button onClick={() => removeCategory(cat.id)} className="text-gray-300 hover:text-red-500 pt-1 opacity-0 group-hover:opacity-100"><Icon name="x" size={14} /></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Workspace = ({ tabId, data, updateTab, isActive }) => {
            const [processing, setProcessing] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [exportModalOpen, setExportModalOpen] = useState(false);

            const getLineContext = (fullText, matchIndex) => {
                const lines = fullText.split('\n');
                let currentPos = 0, targetLineIndex = -1;
                for (let i = 0; i < lines.length; i++) {
                    const lineLen = lines[i].length + 1; 
                    if (matchIndex >= currentPos && matchIndex < currentPos + lineLen) { targetLineIndex = i; break; }
                    currentPos += lineLen;
                }
                if (targetLineIndex === -1) return "Context Error";
                const startLine = Math.max(0, targetLineIndex - 5);
                const endLine = Math.min(lines.length, targetLineIndex + 6);
                return lines.slice(startLine, endLine).map((line, idx) => {
                    const isTarget = (startLine + idx) === targetLineIndex;
                    return isTarget ? `<span class="target-line">${line}</span>` : `<span class="context-line text-gray-500">${line}</span>`;
                }).join('\n');
            };

            const runExtraction = (filesToScan) => {
                setProcessing(true);
                const activeCategories = data.categories.filter(c => c.active !== false);

                if (activeCategories.length === 0) {
                    alert("Vui lòng chọn ít nhất một 'Cấu trúc trích xuất' (tích vào ô vuông) để chạy.");
                    setProcessing(false);
                    return;
                }

                let newResults = [];
                const activeFiles = filesToScan.filter(f => f.selected);

                setTimeout(() => {
                    try {
                        activeFiles.forEach(fileData => {
                            fileData.pages.forEach(page => {
                                activeCategories.forEach(cat => {
                                    let searchTerms = [cat.name];
                                    if (cat.keywords && cat.keywords.trim() !== "") {
                                        searchTerms = cat.keywords.split(',').map(k => k.trim()).filter(k => k);
                                    }
                                    searchTerms.forEach(term => {
                                        const flags = data.settings.caseSensitive ? 'g' : 'gi';
                                        const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
                                        let match, matchCount = 0;
                                        while ((match = regex.exec(page.text)) !== null && matchCount < 50) {
                                            newResults.push({
                                                id: generateId(),
                                                fileName: fileData.name,
                                                fileType: fileData.type,
                                                categoryName: cat.name,
                                                categoryId: cat.id,
                                                keyword: term,
                                                context: getLineContext(page.text, match.index),
                                                fullContent: page.text,
                                                pageIndex: page.pageIndex,
                                                date: new Date().toLocaleString()
                                            });
                                            matchCount++;
                                        }
                                    });
                                });
                            });
                        });
                        updateTab(tabId, { ...data, results: newResults });
                    } catch (e) {
                        console.error(e);
                        alert("Có lỗi xảy ra khi quét: " + e.message);
                    } finally {
                        setProcessing(false);
                    }
                }, 100);
            };

            const handleFileUpload = async (uploadedFiles) => {
                setProcessing(true);
                const newFiles = [];
                for (const file of uploadedFiles) {
                    const pages = await extractContentFromFile(file, data.settings.useOCR);
                    newFiles.push({
                        id: generateId(),
                        name: file.name,
                        type: file.name.split('.').pop(),
                        pages: pages,
                        selected: true 
                    });
                }
                const updatedLibrary = [...data.library, ...newFiles];
                updateTab(tabId, { ...data, library: updatedLibrary });
                runExtraction(updatedLibrary);
            };

            const toggleFile = (id) => {
                const updatedLib = data.library.map(f => f.id === id ? { ...f, selected: !f.selected } : f);
                updateTab(tabId, { ...data, library: updatedLib });
            };
            const deleteFile = (id) => {
                const updatedLib = data.library.filter(f => f.id !== id);
                updateTab(tabId, { ...data, library: updatedLib });
                runExtraction(updatedLib);
            };
            const handleManualScan = () => runExtraction(data.library);

            const groupedResults = useMemo(() => {
                const groups = {};
                data.results.forEach(r => {
                    if (!groups[r.categoryName]) groups[r.categoryName] = [];
                    groups[r.categoryName].push(r);
                });
                return groups;
            }, [data.results]);

            const filteredGroups = useMemo(() => {
                const searchLower = searchTerm.toLowerCase();
                const newGroups = {};
                Object.keys(groupedResults).forEach(key => {
                    const filtered = groupedResults[key].filter(r => 
                        r.fileName.toLowerCase().includes(searchLower) || 
                        r.context.toLowerCase().includes(searchLower) ||
                        r.keyword.toLowerCase().includes(searchLower)
                    );
                    if (filtered.length > 0) newGroups[key] = filtered;
                });
                return newGroups;
            }, [groupedResults, searchTerm]);

            if (!isActive) return <div className="hidden"></div>;

            const totalFiles = data.library.length;
            const selectedFiles = data.library.filter(f => f.selected).length;
            const activeCategoriesCount = data.categories.filter(c => c.active !== false).length;

            return (
                <div className="h-full flex flex-col p-4 gap-4 overflow-hidden relative">
                    <ExportModal isOpen={exportModalOpen} onClose={() => setExportModalOpen(false)} categories={data.categories} data={data} onExport={(fmt, cats) => { exportData(data, {format: fmt, selectedCategories: cats}); setExportModalOpen(false); }} />

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 h-[40vh] min-h-[300px] shrink-0">
                        {/* Categories (3/12) */}
                        <div className="lg:col-span-3 h-full">
                            <CategoryManager categories={data.categories} onChange={(newCats) => updateTab(tabId, { ...data, categories: newCats })} />
                        </div>

                        {/* Library (5/12) */}
                        <div className="lg:col-span-5 h-full">
                            <FileLibrary files={data.library} onToggle={toggleFile} onDelete={deleteFile} onDrop={handleFileUpload} />
                        </div>

                        {/* Controls (4/12) */}
                        <div className="lg:col-span-4 h-full bg-white rounded-lg shadow-sm border p-4 flex flex-col gap-4">
                            
                            {/* NEW: Settings Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                                    <Icon name="settings" size={16} /> Cấu hình Xử lý
                                </h3>
                                <div className="space-y-3">
                                    <label className="flex items-center justify-between cursor-pointer group">
                                        <div className="flex flex-col">
                                            <span className="text-sm font-medium text-gray-700">Chế độ OCR (Đọc ảnh)</span>
                                            <span className="text-[10px] text-gray-400 group-hover:text-blue-500 transition-colors">Tải ngôn ngữ tiếng Việt để đọc ảnh/scan</span>
                                        </div>
                                        <input 
                                            type="checkbox" 
                                            checked={data.settings.useOCR} 
                                            onChange={(e) => updateTab(tabId, { ...data, settings: { ...data.settings, useOCR: e.target.checked } })}
                                            className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                    </label>
                                    <div className="h-px bg-gray-200"></div>
                                    <label className="flex items-center justify-between cursor-pointer">
                                        <span className="text-sm font-medium text-gray-700">Phân biệt Hoa/Thường</span>
                                        <input 
                                            type="checkbox" 
                                            checked={data.settings.caseSensitive} 
                                            onChange={(e) => updateTab(tabId, { ...data, settings: { ...data.settings, caseSensitive: e.target.checked } })}
                                            className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                    </label>
                                </div>
                            </div>

                            {/* Status Section */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex-1">
                                <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2 text-sm">
                                    <Icon name="activity" size={16} /> Trạng thái
                                </h3>
                                <div className="text-sm space-y-2 text-blue-900">
                                    <div className="flex justify-between">
                                        <span>File đã chọn:</span>
                                        <span className="font-bold">{selectedFiles}/{totalFiles}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Cấu trúc bật:</span>
                                        <span className="font-bold text-green-600">{activeCategoriesCount} / {data.categories.length}</span>
                                    </div>
                                    <div className="flex justify-between border-t border-blue-200 pt-2">
                                        <span>Kết quả:</span>
                                        <span className="font-bold">{data.results.length} dòng</span>
                                    </div>
                                </div>
                            </div>

                            {/* Action Button */}
                            <div>
                                {processing ? (
                                    <button disabled className="w-full py-3 bg-gray-100 text-gray-400 rounded font-bold flex items-center justify-center gap-2 cursor-wait">
                                        <Icon name="loader-2" className="animate-spin" /> Đang xử lý...
                                    </button>
                                ) : (
                                    <button onClick={handleManualScan} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                                        <Icon name="refresh-cw" /> Chạy Trích xuất Ngay
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col bg-white rounded-lg shadow-sm border overflow-hidden min-h-0">
                        <div className="p-3 border-b flex items-center justify-between gap-4 bg-gray-50 shrink-0">
                            <div className="flex items-center gap-2 flex-1 max-w-md bg-white border rounded px-3 py-1.5 shadow-sm focus-within:ring-2 ring-blue-100">
                                <Icon name="search" size={16} className="text-gray-400" />
                                <input type="text" placeholder="Tìm kiếm trong kết quả..." className="bg-transparent outline-none text-sm w-full" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => updateTab(tabId, {...data, results: []})} className="p-2 hover:bg-red-100 text-red-600 rounded flex items-center gap-1 text-sm font-medium">
                                    <Icon name="trash-2" size={16} /> Xóa KQ
                                </button>
                                <div className="h-6 w-px bg-gray-300 mx-1"></div>
                                <button onClick={() => setExportModalOpen(true)} className="flex items-center gap-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-bold shadow-sm transition-colors">
                                    <Icon name="download" size={16} /> Xuất Báo Cáo
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">
                            {Object.keys(filteredGroups).length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                                    <Icon name="inbox" size={48} />
                                    <p className="mt-2 text-sm">Chưa có kết quả nào cho các cấu trúc đã chọn.</p>
                                </div>
                            ) : (
                                Object.entries(filteredGroups).map(([catName, rows]) => (
                                    <div key={catName} className="border rounded-lg overflow-hidden shadow-sm">
                                        <div className="bg-blue-50 px-4 py-2 border-b flex justify-between items-center sticky top-0 z-10">
                                            <h3 className="font-bold text-blue-800 flex items-center gap-2">
                                                <Icon name="folder" size={16} /> {catName}
                                                <span className="text-xs font-normal bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">{rows.length}</span>
                                            </h3>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-gray-50 text-gray-600 font-medium border-b text-xs uppercase">
                                                    <tr><th className="p-3 w-48">Nguồn File</th><th className="p-3 w-32">Từ khóa</th><th className="p-3">Ngữ cảnh</th></tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {rows.map(row => (
                                                        <tr key={row.id} className="hover:bg-yellow-50 transition-colors">
                                                            <td className="p-3 align-top">
                                                                <div className="font-medium text-gray-800 truncate w-40" title={row.fileName}>{row.fileName}</div>
                                                                <div className="text-xs text-gray-500 mt-0.5">{typeof row.pageIndex === 'number' ? `Trang ${row.pageIndex}` : row.pageIndex}</div>
                                                            </td>
                                                            <td className="p-3 align-top"><span className="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs border inline-block">{row.keyword}</span></td>
                                                            <td className="p-3 text-gray-600 text-xs font-mono whitespace-pre-wrap bg-gray-50 rounded m-2 border">
                                                                <div dangerouslySetInnerHTML={{ __html: row.context.replace(new RegExp(`(${row.keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<span class="highlight">$1</span>') }} />
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [tabs, setTabs] = useState(() => {
                const saved = localStorage.getItem('extractor_v4_tabs');
                const defaultData = [{
                    id: 'default',
                    name: 'Dự án mẫu',
                    categories: [
                        { id: 'c1', name: 'Cửa', keywords: 'cửa, door', active: true },
                        { id: 'c2', name: 'Trần', keywords: 'trần, ceiling', active: true }
                    ],
                    library: [], 
                    results: [],
                    settings: { useOCR: false, caseSensitive: false }
                }];
                if (saved) {
                    const parsed = JSON.parse(saved);
                    parsed.forEach(t => t.categories.forEach(c => { if (c.active === undefined) c.active = true; }));
                    return parsed;
                }
                return defaultData;
            });
            const [activeTabId, setActiveTabId] = useState(() => tabs[0]?.id || 'default');

            useEffect(() => {
                try {
                    const tabsToSave = tabs.map(tab => ({
                        ...tab,
                        library: tab.library.map(({ pages, ...rest }) => ({ ...rest, pages: [] })),
                        results: tab.results.map(({ fullContent, ...rest }) => rest)
                    }));
                    localStorage.setItem('extractor_v4_tabs', JSON.stringify(tabsToSave));
                } catch (e) { console.warn("Quota exceeded"); }
            }, [tabs]);

            const updateTab = (id, newData) => setTabs(tabs.map(t => t.id === id ? { ...newData } : t));
            const addTab = () => {
                const newId = generateId();
                setTabs([...tabs, { id: newId, name: `Dự án ${tabs.length+1}`, categories: [{id: generateId(), name: 'Mục 1', keywords: '', active: true}], library: [], results: [], settings: { useOCR: false, caseSensitive: false } }]);
                setActiveTabId(newId);
            };
            const activeTab = tabs.find(t => t.id === activeTabId) || tabs[0];

            return (
                <div className="flex h-screen w-screen overflow-hidden bg-gray-100 font-sans text-gray-900">
                    <div className="w-16 bg-white border-r flex flex-col items-center py-4 gap-4 z-10 shadow-lg shrink-0">
                        <div className="bg-blue-600 p-2 rounded-lg text-white mb-2"><Icon name="box" size={24} /></div>
                        {tabs.map(t => (
                            <button key={t.id} onClick={() => setActiveTabId(t.id)} className={`p-2 rounded-lg transition-all relative group ${t.id === activeTabId ? 'bg-blue-50 text-blue-600' : 'text-gray-400 hover:bg-gray-100'}`}>
                                <Icon name="folder" size={20} />
                                <span className="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50 pointer-events-none transition-opacity">{t.name}</span>
                            </button>
                        ))}
                        <button onClick={addTab} className="p-2 rounded-lg text-gray-400 hover:bg-gray-100 mt-auto"><Icon name="plus" size={20} /></button>
                    </div>
                    <div className="flex-1 h-full relative min-w-0">
                        <Workspace key={activeTab.id} tabId={activeTab.id} data={activeTab} updateTab={updateTab} isActive={true} />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
